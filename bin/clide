#!/usr/bin/env ruby
#!/usr/bin/env ruby -r tracer
# vim: fdm=marker

require 'optparse'
require 'pp'
require 'psych'

require_relative '../lib/config'
require_relative '../lib/project'

# Top level command to manage a maven java project from the command line.

#{{{
class Clide
  attr_accessor :conf, :projects

  def initialize
    @conf = ClideConfig.instance
    @plugins  = {}
    @commands = {}
    @projects = {}
  end

  def Clide.is_command_registered?(cmdname)
    @commands.has_key? cmdname
  end

  #{{{
  def generate_classpaths(artifacts = nil)
    # generate the classpath for each module
    @conf[:modules].each_key { |mod|
      cpathfile = @conf[:clide_conf_dir] + mod + @conf[:module][:classpath]

      classpath = Set.new
      artifacts.each { |dep_coordinate|
        classpath << @pom.dependencies[:all][dep_coordinate].get_path_to_dep
      }
    }
    @conf[:classpath][:file].open('w+') { |file| 
      file.write Psych.dump @conf[:classpath]
    }
  end
  #}}}

  ##
  # Initialize/Update clide by parsing the pom and storing the data in the .clide directory
  #{{{
  def init
    # generate and load the effective pom and extract data from it so we don't need to parse it everytime
    unless @conf[:effective_pom].exist?
      `(cd #{@conf[:project_root]}; mvn help:effective-pom -Doutput=#{@conf[:effective_pom]})`
    end
    namespaces = { 'xmlns' => 'http://maven.apache.org/POM/4.0.0' }
    epom = Nokogiri::XML(File.open(@conf[:effective_pom], 'r'))
    epom.xpath("//xmlns:project", namespaces).each { |project_pom|
      project = Project.new(project_pom)

      @projects[project.key] = project
    }
    @conf[:projects] = @projects
  end
  #}}}

  #{{{
  def clean
    Pathname::glob(@conf[:clide_conf_dir] + '*').each { |file| file.delete }
    @conf[:clide_conf_dir].rmdir
    @conf[:cliderc].delete
  end
  #}}}

  #{{{
  def run(args)
    init
  end
  #}}}
end
#}}}

begin
  clide = Clide.new
  clide.run(ARGV)
  ClideConfig.instance.save
rescue
  puts $!
  puts $!.backtrace
  puts "<print help doc here>"
end
